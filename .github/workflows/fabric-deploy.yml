name: Deploy to Microsoft Fabric

# Workflow triggers:
# 1. Automatic: Push to main branch with changes in workspaces/** paths
#    - Deploys all workspaces to Dev environment
#    - Changes outside workspaces/ directory do NOT trigger deployment
# 2. Manual: workflow_dispatch with environment selection (dev/test/prod)
#    - Deploys all workspaces to selected environment
#    - Useful for promoting to Test/Prod or re-deploying Dev
on:
  push:
    branches:
      - main
    paths:
      - 'workspaces/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - test
          - prod

env:
  PYTHON_VERSION: '3.12'
  WORKSPACES_DIRECTORY: 'workspaces'

# Prevent parallel deployments to avoid conflicts
concurrency:
  group: fabric-deploy-${{ github.event_name == 'push' && 'dev' || inputs.environment }}
  cancel-in-progress: false

jobs:
  set-environment:
    name: Resolve deployment environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      trigger_type: ${{ steps.set-env.outputs.trigger_type }}
    steps:
      - name: Set environment variables
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "trigger_type=Automatic" >> $GITHUB_OUTPUT
          else
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
            echo "trigger_type=Manual" >> $GITHUB_OUTPUT
          fi

  terraform:
    name: Run Terraform prerequisites
    needs: [set-environment]
    uses: ./.github/workflows/terraform.yml
    with:
      environment: ${{ needs.set-environment.outputs.environment }}
    secrets: inherit

  # Deploy job - dynamically deploys to the triggered environment only
  # Triggers:
  #   - Dev: Automatic on push to main, or manual via workflow_dispatch
  #   - Test/Prod: Manual only via workflow_dispatch
  # Note: Test and Prod require manual approval if environment protection rules are configured
  # Note: Workspace discovery happens automatically in the Python deployment script
  deploy:
    name: Deploy to ${{ needs.set-environment.outputs.environment == 'dev' && 'Dev' || needs.set-environment.outputs.environment == 'test' && 'Test' || 'Production' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [set-environment, terraform]
    environment:
      name: ${{ needs.set-environment.outputs.environment }}
      url: https://app.fabric.microsoft.com
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        id: install-deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Scan for unmapped IDs
        # Pre-deployment gate: ensure all GUIDs in workspace items are covered
        # by a find_replace rule. Prevents dev-only IDs reaching Test/Production.
        id: id-scan
        run: |
          echo "::group::Unmapped ID Scan"
          python -m scripts.check_unmapped_ids \
            --workspaces_directory "${{ env.WORKSPACES_DIRECTORY }}"
          echo "::endgroup::"
        env:
          GITHUB_ACTIONS: 'true'

      - name: Deploy to Fabric
        id: deploy
        run: |
          python -u -m scripts.deploy_to_fabric \
            --workspaces_directory "${{ env.WORKSPACES_DIRECTORY }}" \
            --environment "${{ needs.set-environment.outputs.environment }}"
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}

      - name: Deployment Summary
        if: always()
        run: |
          # Generate deployment summary using reusable script
          bash scripts/generate_deployment_summary.sh "${{ needs.set-environment.outputs.environment }}" "${{ needs.set-environment.outputs.trigger_type }}"
        env:
          JOB_STATUS: ${{ job.status }}

      - name: Upload deployment results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-results-${{ needs.set-environment.outputs.environment }}-${{ github.run_number }}
          path: deployment-results.json
          if-no-files-found: warn
          retention-days: 30
